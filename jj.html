<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incentives for Deep-Diving</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    /* Tailwind CSS already provides a lot of styling, but feel free to add custom styles here */
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <div id="app" class="min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-6 text-center rounded-b-lg shadow-lg">
      <h1 class="text-3xl font-semibold">Incentives for Deep-Diving</h1>
      <button id="connectWalletBtn" class="mt-4 bg-blue-800 text-white py-2 px-4 rounded-full hover:bg-blue-700 transition duration-300">
        Connect Wallet
      </button>
      <p id="account" class="mt-4 hidden"></p>
    </header>

    <!-- Main Content -->
    <main class="p-8 space-y-8">
      <!-- Error message display -->
      <div id="errorMessage" class="bg-red-200 text-red-700 p-4 rounded-md shadow-lg hidden"></div>

      <!-- Submit Contribution Section -->
      <section class="bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold text-center mb-6">Submit a Contribution</h2>
        <form id="contributionForm" class="space-y-6 max-w-lg mx-auto">
          <input type="text" id="field" placeholder="Field" class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200" required />
          <textarea id="description" placeholder="Description" class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition duration-200" required></textarea>
          <button type="submit" id="submitContributionBtn" class="w-full py-3 text-white bg-green-500 hover:bg-green-600 rounded-md transition duration-300">Submit</button>
        </form>
      </section>

      <!-- Rewards Section -->
      <section class="bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold text-center mb-6">Your Rewards</h2>
        <p id="rewardAmount" class="text-2xl font-bold text-center">0 ETH</p>
        <button id="claimRewardsBtn" class="mt-4 w-full py-3 rounded-md text-white bg-yellow-500 hover:bg-yellow-600 transition duration-300">
          Claim Rewards
        </button>
      </section>

      <!-- All Contributions Section -->
      <section class="bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-6">All Contributions</h2>
        <ul id="contributionsList" class="space-y-4"></ul>
      </section>
    </main>
  </div>

  <script>
    // Contract ABI and Address
    const CONTRACT_ADDRESS = "0xEc952972E95a1B30CD0637A8f058f7d9f6e1dc1c";
    const CONTRACT_ABI = 
      // Paste the ABI generated during compilation here
      [
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "submissionId",
              "type": "uint256"
            }
          ],
          "name": "approveSubmission",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "claimRewards",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "fundRewardPool",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "field",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "description",
              "type": "string"
            }
          ],
          "name": "submitContribution",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "contributor",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "amount",
              "type": "uint256"
            }
          ],
          "name": "RewardClaimed",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "id",
              "type": "uint256"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "contributor",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "reward",
              "type": "uint256"
            }
          ],
          "name": "SubmissionApproved",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "id",
              "type": "uint256"
            },
            {
              "indexed": true,
              "internalType": "address",
              "name": "contributor",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "string",
              "name": "field",
              "type": "string"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "timestamp",
              "type": "uint256"
            }
          ],
          "name": "SubmissionCreated",
          "type": "event"
        },
        {
          "stateMutability": "payable",
          "type": "receive"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "name": "contributors",
          "outputs": [
            {
              "internalType": "address",
              "name": "addr",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "totalIncentives",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "contributorAddress",
              "type": "address"
            }
          ],
          "name": "getContributorRewards",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "submissionId",
              "type": "uint256"
            }
          ],
          "name": "getSubmissionDetails",
          "outputs": [
            {
              "components": [
                {
                  "internalType": "uint256",
                  "name": "id",
                  "type": "uint256"
                },
                {
                  "internalType": "address",
                  "name": "contributor",
                  "type": "address"
                },
                {
                  "internalType": "string",
                  "name": "field",
                  "type": "string"
                },
                {
                  "internalType": "string",
                  "name": "description",
                  "type": "string"
                },
                {
                  "internalType": "uint256",
                  "name": "timestamp",
                  "type": "uint256"
                },
                {
                  "internalType": "uint256",
                  "name": "reward",
                  "type": "uint256"
                },
                {
                  "internalType": "bool",
                  "name": "isApproved",
                  "type": "bool"
                }
              ],
              "internalType": "struct KnowledgeIncentives.Submission",
              "name": "",
              "type": "tuple"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "owner",
          "outputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "rewardPerSubmission",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "rewardPool",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "submissionCounter",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "name": "submissions",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "id",
              "type": "uint256"
            },
            {
              "internalType": "address",
              "name": "contributor",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "field",
              "type": "string"
            },
            {
              "internalType": "string",
              "name": "description",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "timestamp",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "reward",
              "type": "uint256"
            },
            {
              "internalType": "bool",
              "name": "isApproved",
              "type": "bool"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        }
      ];

    // State Variables
    let account = null;
    let contract = null;
    let provider = null;

    // Elements
    const connectWalletBtn = document.getElementById("connectWalletBtn");
    const accountDisplay = document.getElementById("account");
    const errorMessage = document.getElementById("errorMessage");
    const contributionForm = document.getElementById("contributionForm");
    const fieldInput = document.getElementById("field");
    const descriptionInput = document.getElementById("description");
    const submitContributionBtn = document.getElementById("submitContributionBtn");
    const claimRewardsBtn = document.getElementById("claimRewardsBtn");
    const rewardAmountDisplay = document.getElementById("rewardAmount");
    const contributionsList = document.getElementById("contributionsList");

    // Connect to MetaMask wallet
    connectWalletBtn.addEventListener("click", async () => {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        try {
          const accounts = await provider.send("eth_requestAccounts", []);
          account = accounts[0];
          accountDisplay.textContent = `Connected as: ${account}`;
          accountDisplay.classList.remove("hidden");
          const signer = provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
          fetchContributorReward();
          fetchContributions();
        } catch (err) {
          showError("Error connecting wallet: " + err.message);
        }
      } else {
        showError("Please install MetaMask to use this app.");
      }
    });

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove("hidden");
    }

    // Submit Contribution
    contributionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!contract || !fieldInput.value || !descriptionInput.value) {
        showError("Please fill out both fields.");
        return;
      }
      try {
        submitContributionBtn.disabled = true;
        const tx = await contract.submitContribution(fieldInput.value, descriptionInput.value);
        await tx.wait();
        alert("Contribution submitted successfully!");
        fetchContributions();
      } catch (err) {
        showError("Error submitting contribution: " + err.message);
      } finally {
        submitContributionBtn.disabled = false;
      }
    });

    // Fetch Contributor Rewards
    async function fetchContributorReward() {
      try {
        const reward = await contract.getContributorRewards(account);
        rewardAmountDisplay.textContent = ethers.utils.formatEther(reward) + " ETH";
      } catch (err) {
        showError("Error fetching rewards: " + err.message);
      }
    }

    // Claim Rewards
    claimRewardsBtn.addEventListener("click", async () => {
      if (!contract) return;
      try {
        claimRewardsBtn.disabled = true;
        const tx = await contract.claimRewards();
        await tx.wait();
        alert("Rewards claimed successfully!");
        fetchContributorReward();
      } catch (err) {
        showError("Error claiming rewards: " + err.message);
      } finally {
        claimRewardsBtn.disabled = false;
      }
    });

    // Fetch All Contributions
    async function fetchContributions() {
      if (!contract) return;
      try {
        const contributions = [];
        let i = 1;
        while (true) {
          try {
            const contribution = await contract.getSubmissionDetails(i);
            contributions.push(contribution);
            i++;
          } catch (err) {
            break; // No more contributions
          }
        }
        updateContributionsList(contributions);
      } catch (err) {
        showError("Error fetching contributions: " + err.message);
      }
    }

    // Update Contributions List
    function updateContributionsList(contributions) {
      contributionsList.innerHTML = "";
      contributions.forEach((contribution) => {
        const li = document.createElement("li");
        li.className = "p-4 border border-gray-300 rounded-lg";
        li.innerHTML = `
          <p class="font-medium">Field: ${contribution.field}</p>
          <p>Description: ${contribution.description}</p>
          <p>Contributor: ${contribution.contributor}</p>
          <p>Status: ${contribution.isApproved ? "Approved" : "Pending"}</p>
        `;
        contributionsList.appendChild(li);
      });
    }
  </script>
</body>
</html>
